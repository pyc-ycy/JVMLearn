# 方法区

## 1、栈、堆与方法区之间的交互关系

- 栈、堆和方法区三者之间的关系，可以使用下面的流程图来理解：

    <img src="./imgs/20.jpg">
- 图上的元空间即方法区

    <img src="./imgs/21.jpg">
- 

## 2、方法区的理解

- 方法区看作是一块独立于 Java 堆的内存空间，方法区和堆一样也是线程共享的，随JVM启动而创建，大小可以固定也可以动态扩展，同样存在GC和OOM，当JVM关闭，该方法区就会被操作系统释放。当加载大量的第三方的Jar包时，出现类信息加载太多，方法区就有可能出现OOM异常。

## 3、设置方法区大小与OOM

- JDK7以及以前使用如下参数设置方法区大小：

    1）-XX:PermSize：设置永久代的初始分配空间，默认值为20.75M

    2）-XX:MaxPermSize:设置永久代最大可分配空间，32位机器默认是64M，64位默认时82M。
- JDK8以及之后的版本，使用下面的参数进行设置：

    1）-XX:MetaspaceSize：设置元空间初始大小，默认值约为21M

    2）-XX:MaxMetaspceSize:设置元空间最大可分配空间，默认值为-1，即没有限制。

## 4、方法区的内部结构

- 方法区中存储已被虚拟机加载的类型信息、常量、静态常量、即时编译器编译后的代码缓存等。
- 对每个加载的类型（Class、interface、enum、annotation），JVM必须在方法区中存储一下类型信息：

    1）这个类型的完整有效名称，即由包路径和类名构成的类的全限定名

    2）这个类型的直接父类的完整有效名（interface或java.lang.Object除外，此二者都没有父类）

    3）这类型的修饰符

    4）这个类型直接接口的一个有序列表
- 域（Field）信息：JVM 必须在方法区中保存类型的所有域的相关信息和域的声明顺序；域的相关信息包括：域名称、域类型、域修饰符（public、private、protected、static、final、volatile、transient的某个子集）
- JVM 必须保存所有方法的名称、返回类型、参数信息（数量和类型，按顺序）、方法的修饰符、操作数栈、局部变量表及大小和异常表。

### 4.1、运行时常量池

- 运行中的常量池信息称为运行时常量池。运行时常量池中包含多种不同的常量，包括编译期就已经明确的数值字面量，也包括到运行期解析后才能够获得的方法或者字段引用。运行时常量池相对于字节码文件中的常量池表，具有动态性。当创建类或接口的运行时常量池时，如果构造运行时常量池所需的内存空间超过了方法区所能提供的最大值，就会发生OOM错误。

## 5、方法区使用举例

- 见 MethodAreaDemo。

## 6、方法区的演进细节

- JDK7以及以前，习惯上将方法区称为永久代，JDK8以及之后改称元空间，今后也是称元空间。

    <img src="./imgs/22.jpg">
- 

## 6、方法区的垃圾回收

## 7、总结